name: Terraform Infrastructure Provisioning

on:
  push:
    branches: [main]
    paths: ['terraform/**', '.github/workflows/infra.yml', 'src/**', 'kubernetes/**', '!kubernetes/15-keyvault-secret-provider.yml', 'scripts/**', 'Dockerfile', 'docker-compose.yml', 'package*.json']
  pull_request:
    branches: [main] 
    paths: ['terraform/**', '.github/workflows/infra.yml', 'src/**', 'kubernetes/**', '!kubernetes/15-keyvault-secret-provider.yml', 'scripts/**', 'Dockerfile', 'docker-compose.yml', 'package*.json']
  workflow_dispatch:

env:
  TERRAFORM_VERSION: '1.6.0'
  ARM_CLIENT_ID: ${{ secrets.ARM_CLIENT_ID }}
  ARM_CLIENT_SECRET: ${{ secrets.ARM_CLIENT_SECRET }}
  ARM_SUBSCRIPTION_ID: ${{ secrets.ARM_SUBSCRIPTION_ID }}
  ARM_TENANT_ID: ${{ secrets.ARM_TENANT_ID }}

jobs:
  prepare-config:
    name: 'Prepare Terraform Configuration'
    runs-on: ubuntu-latest
    steps:
      - name: Create terraform configuration
        env:
          TF_PROJECT_NAME: ${{ secrets.TF_PROJECT_NAME }}
          TF_LOCATION: ${{ secrets.TF_LOCATION }}
          TF_ACR_NAME: ${{ secrets.TF_ACR_NAME }}
          TF_AKS_CLUSTER_NAME: ${{ secrets.TF_AKS_CLUSTER_NAME }}
          TF_DNS_ZONE_NAME: ${{ secrets.TF_DNS_ZONE_NAME }}
          TF_ARGOCD_NAMESPACE: ${{ secrets.TF_ARGOCD_NAMESPACE }}
          TF_GITHUB_REPO_URL: ${{ secrets.TF_GITHUB_REPO_URL }}
          TF_OBSERVABILITY_NAMESPACE: ${{ secrets.TF_OBSERVABILITY_NAMESPACE }}
          TF_ADMIN_OBJECT_ID: ${{ secrets.TF_ADMIN_OBJECT_ID }}
          TF_OWNER: ${{ secrets.TF_OWNER }}
          TF_STATE_RESOURCE_GROUP: ${{ secrets.TF_STATE_RESOURCE_GROUP }}
          TF_STATE_STORAGE_ACCOUNT: ${{ secrets.TF_STATE_STORAGE_ACCOUNT }}
          TF_STATE_CONTAINER: ${{ secrets.TF_STATE_CONTAINER }}
          TF_STATE_KEY: ${{ secrets.TF_STATE_KEY }}
        run: |
          # Fix UUID format if hyphens are missing
          FIXED_OBJECT_ID="${TF_ADMIN_OBJECT_ID}"
          
          # Check if it's a 32-char string without hyphens (typical UUID without formatting)
          if [[ ${#FIXED_OBJECT_ID} -eq 32 && $FIXED_OBJECT_ID =~ ^[a-fA-F0-9]{32}$ ]]; then
            echo "Detected UUID without hyphens, adding them..."
            # Insert hyphens at positions 8, 12, 16, 20 to format as UUID
            FIXED_OBJECT_ID="${FIXED_OBJECT_ID:0:8}-${FIXED_OBJECT_ID:8:4}-${FIXED_OBJECT_ID:12:4}-${FIXED_OBJECT_ID:16:4}-${FIXED_OBJECT_ID:20:12}"
            echo "Fixed UUID: $FIXED_OBJECT_ID"
          fi
          
          # Create terraform.tfvars using environment variables
          cat > terraform.tfvars << EOF
          project_name = "${TF_PROJECT_NAME}"
          location     = "${TF_LOCATION}"
          acr_name = "${TF_ACR_NAME}"
          aks_cluster_name = "${TF_AKS_CLUSTER_NAME}"
          dns_zone_name = "${TF_DNS_ZONE_NAME}"
          argocd_namespace = "${TF_ARGOCD_NAMESPACE}"
          github_repo_url  = "${TF_GITHUB_REPO_URL}"
          observability_namespace = "${TF_OBSERVABILITY_NAMESPACE}"
          admin_object_id = "${FIXED_OBJECT_ID}"
          tags = {
            Project   = "EasyShop"
            ManagedBy = "Terraform"
            Owner     = "${TF_OWNER}"
          }
          EOF
          
          # Create backend configuration
          cat > backend.conf << EOF
          resource_group_name  = "${TF_STATE_RESOURCE_GROUP}"
          storage_account_name = "${TF_STATE_STORAGE_ACCOUNT}"
          container_name       = "${TF_STATE_CONTAINER}"
          key                  = "${TF_STATE_KEY}"
          EOF
          
          # Clean up any potential line breaks
          sed -i 's/\r$//' terraform.tfvars
          sed -i 's/\r$//' backend.conf
          
          # Debug output (sanitized)
          echo "=== terraform.tfvars content (sanitized) ==="
          sed 's/= ".*"/= "***"/g' terraform.tfvars

      - name: Upload configuration artifacts
        uses: actions/upload-artifact@v4
        with:
          name: terraform-config
          path: |
            terraform.tfvars
            backend.conf
          retention-days: 5

  plan:
    name: 'Terraform Plan'
    runs-on: ubuntu-latest
    needs: prepare-config
    defaults:
      run:
        working-directory: terraform
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: terraform-config
          path: terraform/
      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
      - name: Cache Terraform
        uses: actions/cache@v4
        with:
          path: |
            ~/.terraform.d/plugin-cache
            terraform/.terraform
            terraform/.terraform.lock.hcl
          key: ${{ runner.os }}-terraform-${{ hashFiles('terraform/.terraform.lock.hcl', 'terraform/**/*.tf') }}
          restore-keys: ${{ runner.os }}-terraform-
      - name: Debug and validate terraform.tfvars
        run: |
          echo "=== terraform.tfvars content check ==="
          if [ -f terraform.tfvars ]; then
            echo "File exists, checking for syntax issues..."
            # Check for line breaks in strings
            if grep -n '"\s*$' terraform.tfvars; then
              echo "❌ Found unterminated strings in terraform.tfvars"
              exit 1
            fi
            echo "✅ terraform.tfvars syntax looks good"
            # Show sanitized content
            sed 's/= ".*"/= "***"/g' terraform.tfvars
          else
            echo "❌ terraform.tfvars not found!"
            exit 1
          fi
      - name: Configure Terraform cache & init with auto-unlock
        run: |
          mkdir -p ~/.terraform.d/plugin-cache
          echo 'plugin_cache_dir = "$HOME/.terraform.d/plugin-cache"' > ~/.terraformrc
          terraform init -backend-config="backend.conf"
          
          # Try to force unlock the specific stuck lock
          echo "Attempting to unlock stuck state..."
          terraform force-unlock -force a7a82cd0-608f-5474-bc5f-4f1f09bd1356 || echo "No lock found or unlock failed (this is okay)"
          
          terraform validate
      - name: Terraform Plan
        run: terraform plan -var-file="terraform.tfvars" -out=tfplan -no-color
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan
          path: terraform/tfplan
          retention-days: 5
      - name: Upload cache artifact  
        uses: actions/upload-artifact@v4
        with:
          name: terraform-cache
          path: ~/.terraform.d/plugin-cache
          retention-days: 5

  apply:
    name: 'Terraform Apply'
    runs-on: ubuntu-latest
    needs: [prepare-config, plan]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
    defaults:
      run:
        working-directory: terraform
    outputs:
      key_vault_name: ${{ steps.export.outputs.key_vault_name }}
      managed_identity_client_id: ${{ steps.export.outputs.managed_identity_client_id }}
      tenant_id: ${{ steps.export.outputs.tenant_id }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: terraform-config
          path: terraform/
      - uses: actions/download-artifact@v4
        with:
          name: terraform-cache
          path: ~/.terraform.d/plugin-cache
      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
          terraform_wrapper: false
      - name: Configure cache & apply
        run: |
          echo 'plugin_cache_dir = "$HOME/.terraform.d/plugin-cache"' > ~/.terraformrc
          terraform init -backend-config="backend.conf"
      - uses: actions/download-artifact@v4
        with:
          name: terraform-plan
          path: terraform/
      - name: Terraform Apply & Export
        id: export
        run: |
          terraform apply tfplan -no-color
          echo "key_vault_name=$(terraform output -raw key_vault_name 2>/dev/null || echo 'not-created')" >> $GITHUB_OUTPUT
          echo "managed_identity_client_id=$(terraform output -raw managed_identity_client_id 2>/dev/null || echo 'not-created')" >> $GITHUB_OUTPUT
          echo "tenant_id=$(terraform output -raw tenant_id 2>/dev/null || echo 'not-created')" >> $GITHUB_OUTPUT

  update-k8s-manifests:
    name: 'Update Kubernetes Manifests'
    runs-on: ubuntu-latest
    needs: apply
    if: success()
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      - name: Update & commit manifests
        run: |
          sed -i 's/${MANAGED_IDENTITY_CLIENT_ID}/${{ needs.apply.outputs.managed_identity_client_id }}/g' kubernetes/15-keyvault-secret-provider.yml
          sed -i 's/${TENANT_ID}/${{ needs.apply.outputs.tenant_id }}/g' kubernetes/15-keyvault-secret-provider.yml
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add kubernetes/15-keyvault-secret-provider.yml
          git diff --staged --quiet || git commit -m "Update SecretProviderClass with Terraform outputs [skip ci]"
          git push

  trigger-deploy:
    name: 'Trigger Application Deployment'
    runs-on: ubuntu-latest
    needs: [apply, update-k8s-manifests]
    if: success()
    steps:
      - uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          repository: ${{ github.repository }}
          event-type: deploy-applications
          client-payload: |
            {
              "ref": "${{ github.ref }}",
              "sha": "${{ github.sha }}",
              "key_vault_name": "${{ needs.apply.outputs.key_vault_name }}",
              "managed_identity_client_id": "${{ needs.apply.outputs.managed_identity_client_id }}",
              "tenant_id": "${{ needs.apply.outputs.tenant_id }}"
            }
            