name: Terraform Infrastructure Provisioning

on:
  push:
    branches: [main]
    paths: ['terraform/**', '.github/workflows/infra.yml', 'src/**', 'kubernetes/**', '!kubernetes/15-keyvault-secret-provider.yml', 'scripts/**', 'Dockerfile', 'docker-compose.yml', 'package*.json']
  pull_request:
    branches: [main] 
    paths: ['terraform/**', '.github/workflows/infra.yml', 'src/**', 'kubernetes/**', '!kubernetes/15-keyvault-secret-provider.yml', 'scripts/**', 'Dockerfile', 'docker-compose.yml', 'package*.json']
  workflow_dispatch:

env:
  TERRAFORM_VERSION: '1.6.0'
  ARM_CLIENT_ID: ${{ secrets.ARM_CLIENT_ID }}
  ARM_CLIENT_SECRET: ${{ secrets.ARM_CLIENT_SECRET }}
  ARM_SUBSCRIPTION_ID: ${{ secrets.ARM_SUBSCRIPTION_ID }}
  ARM_TENANT_ID: ${{ secrets.ARM_TENANT_ID }}

jobs:
  security:
    name: 'Security Scan'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Run Trivy security scan
        uses: aquasecurity/trivy-action@0.20.0
        with:
          scan-type: 'config'
          scan-ref: '.'
          format: 'table' 
          severity: 'CRITICAL,HIGH'
      - name: Run Checkov scan
        uses: bridgecrewio/checkov-action@v12.2838.0
        with:
          directory: .
          quiet: true
          framework: terraform
          output_format: cli
          download_external_modules: true

  prepare-config:
    name: 'Prepare Terraform Configuration'
    runs-on: ubuntu-latest
    needs: security
    steps:
      - name: Create terraform configuration
        run: |
          cat > terraform.tfvars << EOF
          project_name = "${{ secrets.TF_PROJECT_NAME }}"
          location     = "${{ secrets.TF_LOCATION }}"
          acr_name = "${{ secrets.TF_ACR_NAME }}"
          aks_cluster_name = "${{ secrets.TF_AKS_CLUSTER_NAME }}"
          dns_zone_name = "${{ secrets.TF_DNS_ZONE_NAME }}"
          argocd_namespace = "${{ secrets.TF_ARGOCD_NAMESPACE }}"
          github_repo_url  = "${{ secrets.TF_GITHUB_REPO_URL }}"
          observability_namespace = "${{ secrets.TF_OBSERVABILITY_NAMESPACE }}"
          admin_object_id = "${{ secrets.TF_ADMIN_OBJECT_ID }}"
          tags = {
            Project   = "EasyShop"
            ManagedBy = "Terraform"
            Owner     = "${{ secrets.TF_OWNER }}"
          }
          EOF
          
          cat > backend.conf << EOF
          resource_group_name  = "${{ secrets.TF_STATE_RESOURCE_GROUP }}"
          storage_account_name = "${{ secrets.TF_STATE_STORAGE_ACCOUNT }}"
          container_name       = "${{ secrets.TF_STATE_CONTAINER }}"
          key                  = "${{ secrets.TF_STATE_KEY }}"
          EOF

      - name: Upload configuration artifacts
        uses: actions/upload-artifact@v4
        with:
          name: terraform-config
          path: |
            terraform.tfvars
            backend.conf
          retention-days: 5

  plan:
    name: 'Terraform Plan'
    runs-on: ubuntu-latest
    needs: prepare-config
    defaults:
      run:
        working-directory: terraform
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: terraform-config
          path: terraform/
      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
      - name: Cache Terraform
        uses: actions/cache@v4
        with:
          path: |
            ~/.terraform.d/plugin-cache
            terraform/.terraform
            terraform/.terraform.lock.hcl
          key: ${{ runner.os }}-terraform-${{ hashFiles('terraform/.terraform.lock.hcl', 'terraform/**/*.tf') }}
          restore-keys: ${{ runner.os }}-terraform-
      - name: Configure Terraform cache & init
        run: |
          mkdir -p ~/.terraform.d/plugin-cache
          echo 'plugin_cache_dir = "$HOME/.terraform.d/plugin-cache"' > ~/.terraformrc
          terraform init -backend-config="backend.conf"
          terraform validate
      - name: Terraform Plan
        run: terraform plan -var-file="terraform.tfvars" -out=tfplan -no-color
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan
          path: terraform/tfplan
          retention-days: 5
      - name: Upload cache artifact  
        uses: actions/upload-artifact@v4
        with:
          name: terraform-cache
          path: ~/.terraform.d/plugin-cache
          retention-days: 5

  apply:
    name: 'Terraform Apply'
    runs-on: ubuntu-latest
    needs: [prepare-config, plan]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
    defaults:
      run:
        working-directory: terraform
    outputs:
      key_vault_name: ${{ steps.export.outputs.key_vault_name }}
      managed_identity_client_id: ${{ steps.export.outputs.managed_identity_client_id }}
      tenant_id: ${{ steps.export.outputs.tenant_id }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: terraform-config
          path: terraform/
      - uses: actions/download-artifact@v4
        with:
          name: terraform-cache
          path: ~/.terraform.d/plugin-cache
      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
          terraform_wrapper: false
      - name: Configure cache & apply
        run: |
          echo 'plugin_cache_dir = "$HOME/.terraform.d/plugin-cache"' > ~/.terraformrc
          terraform init -backend-config="backend.conf"
      - uses: actions/download-artifact@v4
        with:
          name: terraform-plan
          path: terraform/
      - name: Terraform Apply & Export
        id: export
        run: |
          terraform apply tfplan -no-color
          echo "key_vault_name=$(terraform output -raw key_vault_name 2>/dev/null || echo 'not-created')" >> $GITHUB_OUTPUT
          echo "managed_identity_client_id=$(terraform output -raw managed_identity_client_id 2>/dev/null || echo 'not-created')" >> $GITHUB_OUTPUT
          echo "tenant_id=$(terraform output -raw tenant_id 2>/dev/null || echo 'not-created')" >> $GITHUB_OUTPUT

  update-k8s-manifests:
    name: 'Update Kubernetes Manifests'
    runs-on: ubuntu-latest
    needs: apply
    if: success()
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      - name: Update & commit manifests
        run: |
          sed -i 's/${MANAGED_IDENTITY_CLIENT_ID}/${{ needs.apply.outputs.managed_identity_client_id }}/g' kubernetes/15-keyvault-secret-provider.yml
          sed -i 's/${TENANT_ID}/${{ needs.apply.outputs.tenant_id }}/g' kubernetes/15-keyvault-secret-provider.yml
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add kubernetes/15-keyvault-secret-provider.yml
          git diff --staged --quiet || git commit -m "Update SecretProviderClass with Terraform outputs [skip ci]"
          git push

  trigger-deploy:
    name: 'Trigger Application Deployment'
    runs-on: ubuntu-latest
    needs: [apply, update-k8s-manifests]
    if: success()
    steps:
      - uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          repository: ${{ github.repository }}
          event-type: deploy-applications
          client-payload: |
            {
              "ref": "${{ github.ref }}",
              "sha": "${{ github.sha }}",
              "key_vault_name": "${{ needs.apply.outputs.key_vault_name }}",
              "managed_identity_client_id": "${{ needs.apply.outputs.managed_identity_client_id }}",
              "tenant_id": "${{ needs.apply.outputs.tenant_id }}"
            }
            